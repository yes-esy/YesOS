# 1.控制台简介与初始化

## 1.1 控制台简介

![image-20250706163225791](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706163225791.png)

​	计算机上电启动后，显示器默认设置为80列*25行的文本显示模式

![image-20250706163330786](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706163330786.png)

​	每个显示的字符右两个配置字节数据控制：一个字节用于显示字符，一个字节用于配置显示属性。

![image-20250706163426307](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706163426307.png)

​	一屏的显示需要`80 * 25 * 2= 4000B`显存，因此`32KB`可以装下8个屏幕的显示内容。

​	也可以将`32KB`显存分成8块，每块分别用于控制显示虚拟的控制台界面。

![image-20250706163608559](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706163608559.png)

![image-20250706163701650](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706163701650.png)

## 1.2 控制台具体初始化与实现

​	创建`console.c`文件与`.h`文件，控制台的结构定义。

```c
/**
 * 描述显示字符结构
 */
typedef union _disp_char_t
{
    struct
    {
        char c;
        char foreground : 4;
        char background : 3;
    };
    uint16_t v; // 一个字符
} disp_char_t;

/**
 * 控制台
 */
typedef struct _console_t
{
    enum
    {
        CONSOLE_WRITE_NORMAL, // 写普通字符
        CONSOLE_WRITE_ESC,    // 写ESC字符
        CONSOLE_WRITE_SQUARE, // esc方括号
    } write_state;
    disp_char_t *disp_base;       // 起始地址
    int display_rows;             // 行数
    int display_cols;             // 列数
    int cursor_row;               // 光标所在行
    int cursor_col;               // 光标所在列
    cclor_t foreground;           // 前景色
    cclor_t background;           // 后景色
    int old_cursor_col;           // 之前光标的行
    int old_cursor_row;           // 之前关标的列
    int esc_param[ESC_PARAM_MAX]; // ESC [ ;;参数数量
    int curr_param_index;         // esc参数索引
} console_t;
```

​	`console_init()`,实现：

```c
/**
 * @brief        : 初始化控制台
 * @return        {int} :返回0
 **/
int console_init(void)
{
    for (int i = 0; i < CONSOLE_NR; i++)
    {
        console_t *console = console_buff + i;   // 第几个控制台
        console->display_cols = CONSOLE_COL_MAX; // 行数
        console->display_rows = CONSOLE_ROW_MAX; // 列数
        console->foreground = COLOR_White;
        console->background = COLOR_Black;
        int cursor_pos = read_cursor_pos();                       // 读取光标位置
        console->cursor_row = cursor_pos / console->display_cols; // 当前关标行号
        console->cursor_col = cursor_pos % console->display_cols; // 当前光标列号
        console->disp_base = (disp_char_t *)CONSOLE_DISP_ADDR + i * (CONSOLE_COL_MAX * CONSOLE_ROW_MAX);
        console->old_cursor_col = console->cursor_col, console->old_cursor_row = console->cursor_row; // 保存关标的位置
        console->write_state = CONSOLE_WRITE_NORMAL;                                                  // 初始状态写普通字符
        // clear_display(console);
    }
    return 0;
}
```

# 2.控制台上显示字符

`console_write()`实现，写显存，

```c
/**
 * @brief        : 往控制台写数据
 * @param         {int} console: 哪一个控制台
 * @param         {char *} data: 要写的数据
 * @param         {int} size: 大小
 * @return        {int} 返回写入的长度
 **/
int console_write(int console_id, char *data, int size)
{
    console_t *console = console_buff + console_id; // 获取当前控制台;

    int len;
    for (len = 0; len < size; len++)
    {
        char ch = *data++;
        switch (console->write_state)
        {
        case CONSOLE_WRITE_NORMAL: // 写普通字符
            write_normal(console, ch);
            break;
        case CONSOLE_WRITE_ESC: // 写特殊字符
            write_esc(console, ch);
            break;
        case CONSOLE_WRITE_SQUARE: // 写esc参数列表
            write_esc_square(console, ch);
        default:
            break;
        }

        // @todo
    }
    update_cursor_pos(console); // 更新光标位置
    return len;
}
```

添加相关显存的存储映射

```c
/* 映射4: 扩展内存区域
         * 虚拟地址: MEM_EXT_START ~ MEM_EXT_END
         * 物理地址: MEM_EXT_START (identity mapping，一一对应)
         * 权限: PTE_W (可读写)
         * 用途: 1MB以上扩展内存，用于动态分配、用户进程等 */
        {(void *)MEM_EXT_START, (void *)MEM_EXT_END, (void *)MEM_EXT_START, PTE_W},

```

修改`log_printf()`函数，添加显示到控制台的方式

```c
/**
 * @brief        : 实现打印的功能(类似printf)
 * @param         {char} *fmt: 格式化字符串
 * @return        {*}
 **/
void log_printf(const char *fmt, ...)
{
    char str_buf[128];
    va_list args;                                  // 可变参数存储变量
    kernel_memset(str_buf, '\0', sizeof(str_buf)); // 清空缓冲区
    va_start(args, fmt);                           // 将fmt后的可变参数存储到args中
    kernel_vsprintf(str_buf, fmt, args);           // 将可变参数放入缓冲区
    va_end(args);
    // irq_state_t state = irq_enter_protection(); // 进入临界区
    mutex_lock(&mutex);
#if USE_LOG_COM
    const char *p = str_buf;
    while (*p != '\0')
    {
        while ((inb(COM1_PORT + 5) & (1 << 6)) == 0) // 正在忙则等待
            ;
        outb(COM1_PORT, *p++); // 发送数据
    }
    outb(COM1_PORT, '\r');
    outb(COM1_PORT, '\n');
#else
    console_write(0, str_buf, kernel_strlen(str_buf)); // 输出
    char c = '\n';
    console_write(0, &c, 1); // 换行
#endif
    // irq_leave_protection(state); // 退出临界区
    mutex_unlock(&mutex);
}

```



# 3.处理换行和清屏

​	清屏

```c
/**
 * @brief        : 清空控制台
 * @param         {console_t} *console: 需要清空的控制台指针
 * @return        {void}
 **/
static void clear_display(console_t *console)
{
    int size = console->display_cols * console->display_rows; // 清空的大小
    disp_char_t *disp_start = console->disp_base;             // 起始地址
    for (int i = 0; i < size; i++, disp_start++)
    {
        disp_start->c = ' ';
        disp_start->background = console->background;
        disp_start->foreground = console->foreground;
    }
}
```

​	换行

![image-20250706165119278](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706165119278.png)

```c
/**
 * @brief        : 往上滚动,往前拷贝
 * @param         {console_t *} console: 要操作的控制台
 * @param         {int} lines: 上滚的行数
 * @return        {void}
 **/
static void scroll_up(console_t *console, int lines)
{
    disp_char_t *dest = console->disp_base;                                                        // 目标位置，从屏幕第一行开始
    disp_char_t *src = console->disp_base + console->display_cols * lines;                         // 源位置，从要保留的第一行开始（跳过要删除的行数）
    uint32_t size = (console->display_rows - lines) * console->display_cols * sizeof(disp_char_t); // 拷贝大小
    kernel_memcpy((void *)dest, (void *)src, size);
    erase_rows(console, console->display_rows - lines, console->display_rows - 1); // 擦除已经拷贝的行
    console->cursor_row -= lines;
}
```

# 4. 设置光标并重定向日志输出

​	光标的主要作用是帮助用户感知下一字符显示的位置。在文本模式下，计算机显示硬件自动会提供一个光标，并且经BIOS设置后会显示在屏幕上。

![image-20250706165639260](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250706165639260.png)

​	但是，当我们在显存上写入字符后，光标并不会自动调整位置。因此，我们要做的只是随着显示的位置，调整光标的显示位置，无需再初始化。

​	光标的位置为在整个屏幕中显示的字符序号。在当前的显示模式下，显示范围为80列*25行，因此总共有2000个字符，如果以0开始进行编址，则光标的地址范围为0~1999。即屏幕左上角的位置为0，右下角的位置为1999.

​	显示设备使用16位数据表示该位置，即由两个8位寄存器表示。要访问这两位寄存器，需要通过0x3D4和0x3D5端口。其中往0x3D4写入0xE或者0xF来决定当前访问高8位还是低8位，然后再往0x3D5写入或读取相应的寄存器值。![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657753095975-292c2fac-ccc7-45c0-af84-36e882cbf24e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

```c
/**
 * @brief        : 读取光标的位置
 * @return        {int} : 光标的索引
 **/
static int read_cursor_pos(void)
{
    int pos;
    outb(0x3D4, 0xF);
    pos = inb(0x3D5);
    outb(0x3D4, 0xE);
    pos |= inb(0x3D5) << 8;
    return pos;
}

```

```c
/**
 * @brief        : 写入光标的位置
 * @return        {int} : 光标的索引
 **/
static int update_cursor_pos(console_t *console)
{
    uint16_t pos = console->cursor_row * console->display_cols + console->cursor_col; // 获取光标位置

    outb(0x3D4, 0xF);
    outb(0x3D5, (uint8_t)(pos & 0xFF));
    outb(0x3D4, 0xE);
    outb(0x3D5, (uint8_t)((pos >> 8) & 0xFF));
    return pos;
}
```

# 5.转义及删除字符处理

主要解决以下字符的输出处理：

- \n: 换行 LF，移到下行同列（注意，不移到行首）
- \r: 回车 CR，移到行首（注意，不移到下列）
- \t：TAB, 对齐到下一制表符
- \b: BS 左移一个字符
- 其中\r和\n比较特别，为了实现按下键盘上回车键后换行的功能，需要同时使用\r\n才能换到下行行首。

```c
/**
 * @brief        : 向控制台输出正常字符
 * @param         {console_t *} console: 操作的控制台
 * @param         {char} ch: 输出的字符
 * @return        {void}
 **/
static void write_normal(console_t *console, char ch)
{
    switch (ch)
    {
    case ASCII_ESC:
        console->write_state = CONSOLE_WRITE_ESC; // 状态调整为写esc字符
        break;
    case 0x7F:
        erase_backword(console); // 往前删除一个字符
        break;
    case '\b':
        move_backword(console, 1); // 往左移动一个光标
        break;
    case '\r':
        move_to_col0(console); // 回车
    case '\n':                 // 换行
        move_to_col0(console);
        move_next_line(console);
        break;
    default:
        if ((ch >= ' ') && (ch <= '~')) // 可打印
        {
            show_char(console, ch);
        }
        break;
    }
}
```

# 6.保存并恢复光标

​	主要实现光标的保存与恢复。

```c
/**
 * @brief        : 保存光标
 * @param         {console_t} *console: 需要操作的控制台
 * @return        {void}
 **/
static void save_cursor(console_t *console)
{
    console->old_cursor_col = console->cursor_col; // 保存光标行
    console->old_cursor_row = console->cursor_row; // 保存光标列
}
/**
 * @brief        : 恢复光标
 * @param         {console_t} *console: 需要操作的控制台
 * @return        {void}
 **/
static void restore_cusor(console_t *console)
{
    console->cursor_col = console->old_cursor_col; // 恢复光标行
    console->cursor_row = console->old_cursor_row; // 恢复光标列
}
```

# 6.更新字体的颜色

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1658291258043-fe99209b-c854-45aa-ada8-e9c2f4a370db.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_12%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

# 7.移动光标位置及清屏

```c
/**
 * @brief        : 关标右移
 * @param         {console_t} *console: 操作的控制台
 * @param         {int} n: 移动的单位数
 * @return        {void}
 **/
static void move_left(console_t *console, int n)
{
    if (n == 0)
    {
        n = 1;
    }

    int col = console->cursor_col - n; // 光标移动后的列数
    console->cursor_col = (col >= 0) ? col : 0;
}
/**
 * @brief        : 光标左移
 * @param         {console_t} *console: 要操作的控制台
 * @param         {int} n: 移动的位置
 * @return        {void}
 **/
static void move_right(console_t *console, int n)
{
    if (n == 0)
    {
        n = 1;
    }

    int col = console->cursor_col + n; // 光标移动后的列数
    if (col >= console->display_cols)
    {
        console->cursor_col = console->display_cols - 1; // 移动到最后一列
    }
    else
    {
        console->cursor_col = col;
    }
}
/**
 * @brief        : 移动关标
 * @param         {console_t} *console: 操作的控制台
 * @return        {void}
 **/
static void move_cursor(console_t *console)
{
    console->cursor_row = console->esc_param[0]; // 光标行指定位置
    console->cursor_col = console->esc_param[1]; // 关标列指定位置
}
```

# 8.键盘的初始化

​	如下图所示，PC机中使用键盘控制器（KBC）处理键盘与鼠标的连接。键盘和鼠标通过KBC与CPU进行通信，并且连接到中断控制器IRQ1和IRQ12。![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657766598831-5f76213d-ebe5-4a4e-b4dc-c77d2d5597cd.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_13%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

​	我们可以通过端口0x60和0x64对KBC进行配置以及读取相应的数据。

| IO Port | 读写  | 功能       |
| ------- | ----- | ---------- |
| 0x60    | 读/写 | 数据寄存器 |
| 0x64    | 只读  | 状态寄存器 |
| 0x64    | 只写  | 命令寄存器 |

其中状态寄存器的值如下（摘自osdev）：

| Bit  | Meaning                                                      |
| ---- | ------------------------------------------------------------ |
| 0    | 输出缓存寄存器(0 = 空，无数据, 1 = 满，有数据)               |
| 1    | 输入缓存寄存器(0 = 空，无数据, 1 = 满，有数据)               |
| 2    | 系统标志位                                                   |
| 3    | 命令或数据(0 = data written to input buffer is data for PS/2 device, 1 = data written to input buffer is data for PS/2 controller command) |
| 4    | -                                                            |
| 5    | -                                                            |
| 6    | 是否发生超时错误 (0 = no error, 1 = time-out error)          |
| 7    | 是否发生奇偶校验错误 (0 = no error, 1 = parity error)        |

​	在计算机上电后，BIOS会自动完成对键盘相关的初始化，因此我们只需要使用缺省值即可，无需再次初始化。如果需要再次进行初始化，可以参考下方的参考资料。

```c
/**
 * @brief        : 初始化
 * @return        {*}
 **/
void kbd_init(void)
{
    kernel_memset((void *)&kbd_state, 0, sizeof(kbd_state_t));
    irq_install(IRQ1_KEYBOARD, (irq_handler_t)exception_handler_kbd); // 安装键盘处理程序
    irq_enable(IRQ1_KEYBOARD);                                        // 打开键盘中断
}
/**
 * @brief        : 中断服务子程序
 * @param         {exception_frame_t *} frame: 函数栈帧
 * @return        {void}
 **/
void do_handler_kbd(exception_frame_t *frame)
{
    static enum {
        NORMAL,
        BEGIN_E0,
        BEGIN_E1,
    } recv_state = NORMAL;                // 键盘初始状态
    uint32_t status = inb(KBD_PORT_STAT); // 读取状态,检测是否有程序
    if (!(status & KBD_STAT_RECV_READY))  // 非键盘中断
    {
        pic_send_eoi(IRQ1_KEYBOARD);
        return;
    }
    uint8_t raw_code = inb(KBD_PORT_DATA); // 读取键盘的值
    // do_normal_key(raw_code);
    // log_printf("key %d", raw_code);
    pic_send_eoi(IRQ1_KEYBOARD); // 读取完成之后，就可以发EOI，方便后续继续响应键盘中断

    if (raw_code == KEY_E0) // E0字符
    {
        recv_state = BEGIN_E0;
    }
    else if (raw_code == KEY_E1) // E1字符
    {
        recv_state = BEGIN_E1;
    }
    else
    {
        switch (recv_state)
        {
        case NORMAL:
            do_normal_key(raw_code);
            break;
        case BEGIN_E0: // 不处理print scr
            do_e0_key(raw_code);
            recv_state = NORMAL;
            break;
        case BEGIN_E1: // 不处理pause
            recv_state = NORMAL;
            break;
        }
    }
}
```

​	并添加中断处理函数。

# 9.借助按键映射表进行键值转换

当按键按下时，将触发中断，可从中断中读取按键的键值，但是这个值并非按键上的字符丝印对应的字符，而是某种特定编码的数值，这套编码为键盘扫描码集1（Scan Code Set 1）。该表如下所示（摘自osdev，见下方参考资料中的链接）。

该套扫描码的值具体分析如下：

每个键按下和弹起时，都会产生扫描码(scan code)

扫描码根据字节量可分为三种：

单个字节

以E0开头的2字节或4字节

以E1开头的6字节（只有一两个键）

扫描码根据按下和弹起，又分为：make code，break code，区别是扫描码的最高位第7位是否为1，例如：

当A键按下时，产生扫描码0x1E（第7位为0）；断开时，产生扫描码0x9E（第7位为1）

当光标向左键按下时，产生扫描码0xE0, 0x4B（第7位为0）；断开时，产生扫描码0xE0, 0xCB（第7位为1）

键盘也是分为很多种的，所以扫描码中的有些键并不出现在我们常用的键盘上。

| Scan code  | Key                                  | Scan code                          | Key                                | Scan code  | Key                                 | Scan code              | Key                               |
| ---------- | ------------------------------------ | ---------------------------------- | ---------------------------------- | ---------- | ----------------------------------- | ---------------------- | --------------------------------- |
|            |                                      | 0x01                               | escape pressed                     | 0x02       | 1 pressed                           | 0x03                   | 2 pressed                         |
| 0x04       | 3 pressed                            | 0x05                               | 4 pressed                          | 0x06       | 5 pressed                           | 0x07                   | 6 pressed                         |
| 0x08       | 7 pressed                            | 0x09                               | 8 pressed                          | 0x0A       | 9 pressed                           | 0x0B                   | 0 (zero) pressed                  |
| 0x0C       | - pressed                            | 0x0D                               | = pressed                          | 0x0E       | backspace pressed                   | 0x0F                   | tab pressed                       |
| 0x10       | Q pressed                            | 0x11                               | W pressed                          | 0x12       | E pressed                           | 0x13                   | R pressed                         |
| 0x14       | T pressed                            | 0x15                               | Y pressed                          | 0x16       | U pressed                           | 0x17                   | I pressed                         |
| 0x18       | O pressed                            | 0x19                               | P pressed                          | 0x1A       | [ pressed                           | 0x1B                   | ] pressed                         |
| 0x1C       | enter pressed                        | 0x1D                               | left control pressed               | 0x1E       | A pressed                           | 0x1F                   | S pressed                         |
| 0x20       | D pressed                            | 0x21                               | F pressed                          | 0x22       | G pressed                           | 0x23                   | H pressed                         |
| 0x24       | J pressed                            | 0x25                               | K pressed                          | 0x26       | L pressed                           | 0x27                   | ; pressed                         |
| 0x28       | ' (single quote) pressed             | 0x29                               | ` (back tick) pressed              | 0x2A       | left shift pressed                  | 0x2B                   | \ pressed                         |
| 0x2C       | Z pressed                            | 0x2D                               | X pressed                          | 0x2E       | C pressed                           | 0x2F                   | V pressed                         |
| 0x30       | B pressed                            | 0x31                               | N pressed                          | 0x32       | M pressed                           | 0x33                   | , pressed                         |
| 0x34       | . pressed                            | 0x35                               | / pressed                          | 0x36       | right shift pressed                 | 0x37                   | (keypad) * pressed                |
| 0x38       | left alt pressed                     | 0x39                               | space pressed                      | 0x3A       | CapsLock pressed                    | 0x3B                   | F1 pressed                        |
| 0x3C       | F2 pressed                           | 0x3D                               | F3 pressed                         | 0x3E       | F4 pressed                          | 0x3F                   | F5 pressed                        |
| 0x40       | F6 pressed                           | 0x41                               | F7 pressed                         | 0x42       | F8 pressed                          | 0x43                   | F9 pressed                        |
| 0x44       | F10 pressed                          | 0x45                               | NumberLock pressed                 | 0x46       | ScrollLock pressed                  | 0x47                   | (keypad) 7 pressed                |
| 0x48       | (keypad) 8 pressed                   | 0x49                               | (keypad) 9 pressed                 | 0x4A       | (keypad) - pressed                  | 0x4B                   | (keypad) 4 pressed                |
| 0x4C       | (keypad) 5 pressed                   | 0x4D                               | (keypad) 6 pressed                 | 0x4E       | (keypad) + pressed                  | 0x4F                   | (keypad) 1 pressed                |
| 0x50       | (keypad) 2 pressed                   | 0x51                               | (keypad) 3 pressed                 | 0x52       | (keypad) 0 pressed                  | 0x53                   | (keypad) . pressed                |
|            |                                      |                                    |                                    |            |                                     | 0x57                   | F11 pressed                       |
| 0x58       | F12 pressed                          |                                    |                                    |            |                                     |                        |                                   |
|            |                                      | 0x81                               | escape released                    | 0x82       | 1 released                          | 0x83                   | 2 released                        |
| 0x84       | 3 released                           | 0x85                               | 4 released                         | 0x86       | 5 released                          | 0x87                   | 6 released                        |
| 0x88       | 7 released                           | 0x89                               | 8 released                         | 0x8A       | 9 released                          | 0x8B                   | 0 (zero) released                 |
| 0x8C       | - released                           | 0x8D                               | = released                         | 0x8E       | backspace released                  | 0x8F                   | tab released                      |
| 0x90       | Q released                           | 0x91                               | W released                         | 0x92       | E released                          | 0x93                   | R released                        |
| 0x94       | T released                           | 0x95                               | Y released                         | 0x96       | U released                          | 0x97                   | I released                        |
| 0x98       | O released                           | 0x99                               | P released                         | 0x9A       | [ released                          | 0x9B                   | ] released                        |
| 0x9C       | enter released                       | 0x9D                               | left control released              | 0x9E       | A released                          | 0x9F                   | S released                        |
| 0xA0       | D released                           | 0xA1                               | F released                         | 0xA2       | G released                          | 0xA3                   | H released                        |
| 0xA4       | J released                           | 0xA5                               | K released                         | 0xA6       | L released                          | 0xA7                   | ; released                        |
| 0xA8       | ' (single quote) released            | 0xA9                               | ` (back tick) released             | 0xAA       | left shift released                 | 0xAB                   | \ released                        |
| 0xAC       | Z released                           | 0xAD                               | X released                         | 0xAE       | C released                          | 0xAF                   | V released                        |
| 0xB0       | B released                           | 0xB1                               | N released                         | 0xB2       | M released                          | 0xB3                   | , released                        |
| 0xB4       | . released                           | 0xB5                               | / released                         | 0xB6       | right shift released                | 0xB7                   | (keypad) * released               |
| 0xB8       | left alt released                    | 0xB9                               | space released                     | 0xBA       | CapsLock released                   | 0xBB                   | F1 released                       |
| 0xBC       | F2 released                          | 0xBD                               | F3 released                        | 0xBE       | F4 released                         | 0xBF                   | F5 released                       |
| 0xC0       | F6 released                          | 0xC1                               | F7 released                        | 0xC2       | F8 released                         | 0xC3                   | F9 released                       |
| 0xC4       | F10 released                         | 0xC5                               | NumberLock released                | 0xC6       | ScrollLock released                 | 0xC7                   | (keypad) 7 released               |
| 0xC8       | (keypad) 8 released                  | 0xC9                               | (keypad) 9 released                | 0xCA       | (keypad) - released                 | 0xCB                   | (keypad) 4 released               |
| 0xCC       | (keypad) 5 released                  | 0xCD                               | (keypad) 6 released                | 0xCE       | (keypad) + released                 | 0xCF                   | (keypad) 1 released               |
| 0xD0       | (keypad) 2 released                  | 0xD1                               | (keypad) 3 released                | 0xD2       | (keypad) 0 released                 | 0xD3                   | (keypad) . released               |
|            |                                      |                                    |                                    |            |                                     | 0xD7                   | F11 released                      |
| 0xD8       | F12 released                         |                                    |                                    |            |                                     |                        |                                   |
| 0xE0, 0x10 | (multimedia) previous track pressed  |                                    |                                    |            |                                     |                        |                                   |
|            |                                      | 0xE0, 0x19                         | (multimedia) next track pressed    |            |                                     |                        |                                   |
| 0xE0, 0x1C | (keypad) enter pressed               | 0xE0, 0x1D                         | right control pressed              |            |                                     |                        |                                   |
| 0xE0, 0x20 | (multimedia) mute pressed            | 0xE0, 0x21                         | (multimedia) calculator pressed    | 0xE0, 0x22 | (multimedia) play pressed           |                        |                                   |
| 0xE0, 0x24 | (multimedia) stop pressed            |                                    |                                    |            |                                     |                        |                                   |
|            |                                      |                                    |                                    | 0xE0, 0x2E | (multimedia) volume down pressed    |                        |                                   |
| 0xE0, 0x30 | (multimedia) volume up pressed       |                                    |                                    | 0xE0, 0x32 | (multimedia) WWW home pressed       |                        |                                   |
|            |                                      | 0xE0, 0x35                         | (keypad) / pressed                 |            |                                     |                        |                                   |
| 0xE0, 0x38 | right alt (or altGr) pressed         |                                    |                                    |            |                                     |                        |                                   |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0x47             | home pressed                      |
| 0xE0, 0x48 | cursor up pressed                    | 0xE0, 0x49                         | page up pressed                    |            |                                     | 0xE0, 0x4B             | cursor left pressed               |
|            |                                      | 0xE0, 0x4D                         | cursor right pressed               |            |                                     | 0xE0, 0x4F             | end pressed                       |
| 0xE0, 0x50 | cursor down pressed                  | 0xE0, 0x51                         | page down pressed                  | 0xE0, 0x52 | insert pressed                      | 0xE0, 0x53             | delete pressed                    |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0x5B             | left GUI pressed                  |
| 0xE0, 0x5C | right GUI pressed                    | 0xE0, 0x5D                         | "apps" pressed                     | 0xE0, 0x5E | (ACPI) power pressed                | 0xE0, 0x5F             | (ACPI) sleep pressed              |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0x63             | (ACPI) wake pressed               |
|            |                                      | 0xE0, 0x65                         | (multimedia) WWW search pressed    | 0xE0, 0x66 | (multimedia) WWW favorites pressed  | 0xE0, 0x67             | (multimedia) WWW refresh pressed  |
| 0xE0, 0x68 | (multimedia) WWW stop pressed        | 0xE0, 0x69                         | (multimedia) WWW forward pressed   | 0xE0, 0x6A | (multimedia) WWW back pressed       | 0xE0, 0x6B             | (multimedia) my computer pressed  |
| 0xE0, 0x6C | (multimedia) email pressed           | 0xE0, 0x6D                         | (multimedia) media select pressed  |            |                                     |                        |                                   |
| 0xE0, 0x90 | (multimedia) previous track released |                                    |                                    |            |                                     |                        |                                   |
|            |                                      | 0xE0, 0x99                         | (multimedia) next track released   |            |                                     |                        |                                   |
| 0xE0, 0x9C | (keypad) enter released              | 0xE0, 0x9D                         | right control released             |            |                                     |                        |                                   |
| 0xE0, 0xA0 | (multimedia) mute released           | 0xE0, 0xA1                         | (multimedia) calculator released   | 0xE0, 0xA2 | (multimedia) play released          |                        |                                   |
| 0xE0, 0xA4 | (multimedia) stop released           |                                    |                                    |            |                                     |                        |                                   |
|            |                                      |                                    |                                    | 0xE0, 0xAE | (multimedia) volume down released   |                        |                                   |
| 0xE0, 0xB0 | (multimedia) volume up released      |                                    |                                    | 0xE0, 0xB2 | (multimedia) WWW home released      |                        |                                   |
|            |                                      | 0xE0, 0xB5                         | (keypad) / released                |            |                                     |                        |                                   |
| 0xE0, 0xB8 | right alt (or altGr) released        |                                    |                                    |            |                                     |                        |                                   |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0xC7             | home released                     |
| 0xE0, 0xC8 | cursor up released                   | 0xE0, 0xC9                         | page up released                   |            |                                     | 0xE0, 0xCB             | cursor left released              |
|            |                                      | 0xE0, 0xCD                         | cursor right released              |            |                                     | 0xE0, 0xCF             | end released                      |
| 0xE0, 0xD0 | cursor down released                 | 0xE0, 0xD1                         | page down released                 | 0xE0, 0xD2 | insert released                     | 0xE0, 0xD3             | delete released                   |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0xDB             | left GUI released                 |
| 0xE0, 0xDC | right GUI released                   | 0xE0, 0xDD                         | "apps" released                    | 0xE0, 0xDE | (ACPI) power released               | 0xE0, 0xDF             | (ACPI) sleep released             |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0xE3             | (ACPI) wake released              |
|            |                                      | 0xE0, 0xE5                         | (multimedia) WWW search released   | 0xE0, 0xE6 | (multimedia) WWW favorites released | 0xE0, 0xE7             | (multimedia) WWW refresh released |
| 0xE0, 0xE8 | (multimedia) WWW stop released       | 0xE0, 0xE9                         | (multimedia) WWW forward released  | 0xE0, 0xEA | (multimedia) WWW back released      | 0xE0, 0xEB             | (multimedia) my computer released |
| 0xE0, 0xEC | (multimedia) email released          | 0xE0, 0xED                         | (multimedia) media select released |            |                                     |                        |                                   |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0x2A, 0xE0, 0x37 | print screen pressed              |
|            |                                      |                                    |                                    |            |                                     | 0xE0, 0xB7, 0xE0, 0xAA | print screen released             |
|            |                                      | 0xE1, 0x1D, 0x45, 0xE1, 0x9D, 0xC5 | pause pressed                      |            |                                     |                        |                                   |

除扫描码集2之外，还有扫描码集1和3，这两套我们一般不用，具体说明请见下方参考资料。![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657781279743-b5acb925-29db-4a32-a7e9-71662fe5e1f1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_20%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657781243788-20b3c771-97ea-4c5b-8fa3-3f7e8f17208a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657781358465-8f23c1c0-34f3-4a1e-a2fe-07ff0e4f8e04.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

# 10.处理`CapsLK`键

如下图所示，capslock位置如标流所指。这个键本身并不任何有效的字符输入，而是用于控制其它键输入的效果：

capslock：每按1次转换一下,键上方有对应的大小写指示灯(绿灯亮为大写字母输入模式,反之为小写字母输入模式)。如果shift键和Capslock键一起按时，是小写字母模式。![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657837361422-e53280be-f24d-4bc2-9cd6-5e8e149bc383.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

此外，按下capslock后，还需要更新其上的led灯显示状态，可通过如下命令来更新。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657838985194-0e7faef4-249a-4a74-8905-ce31b5fbe604.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

注：由于qemu的特点，我们无法直观看到其设置效果，但是可以通过给qemu添加日志输出查看：ps2_set_ledstate。在未来，如果系统迁移到物理机器上，应该是可以直观地看到其LED变化。

# 11.处理其他特殊功能键

​	键盘上的一些功能键，在不同的操作系统和应用程序下可能有不同的用户，例如在浏览器中，F1键可能是用于打开帮助页面。我们现在是在键盘驱动程序中编写代码，F1等功能键不对应于任何具体的字符，也不对应具体的功能；因此，目前只是在代码中将其识别出来，具体有什么用可以留等以后扩展。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12764787/1657839867641-0fa2f16c-c029-4efc-8045-2be70cccefb6.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_87%2Ctext_5p2O6L-w6ZOc%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp)

> <span style="color:red; background:pink"> 本章文档较为草率，主要原因为：代码中很多都能表现其含义原理等，</span>



















